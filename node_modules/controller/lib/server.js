module.exports = ControllerServer;

var os = require('os');

function ControllerServer() {

  this.marshals = {};

  this.info = {
    process: os.hostname() + '/' + process.pid
  };

}

ControllerServer.prototype.start = function($happn, www, callback) {

  var _this = this;

  $happn._mesh.datalayer.events.on('attach', function(ev) {
    // console.log('attached', JSON.stringify(ev, null, 2));
  });

  $happn._mesh.datalayer.events.on('detatch', function(ev) {
    // console.log('detatched', JSON.stringify(ev, null, 2));

    var name;

    try { 
      name = ev.info.mesh.name;
    } catch (e) {
      $happn.log.error('detatch without name', e);
      return;
    }

    if (_this.marshals[name]) {
      $happn.emit('marshal/destroyed', _this.marshals[name]);
      delete _this.marshals[name];
    }

  });

  setInterval(function() {

    $happn.emit('keepalive', {
      master: _this.info
    });

  }, 1000);


  setInterval(function() {

    www.exchange.www.update({

      marshals: _this.marshals

    }, function() {});

  }, 2000);
  
  callback();

}

/**
 * ### .registerMarshal(registration)
 * 
 * Called by controller.Marshal when ready for instruction.
 *
 */

ControllerServer.prototype.registerMarshal = function($happn, registration, callback) {

  var name = registration.info.mesh.name;
  this.marshals[name] = registration;
  this.marshals[name].minions = this.marshals[name].minions || {};

  $happn.emit('marshal/created', registration);

  callback(null, this.info);

}


/**
 * ### .spawnMinions(opts)
 *
 */

ControllerServer.prototype.spawnMinions = function($happn, opts, callback) {

  $happn.log.info('spawnMinions %j', opts);
  
  var count = opts.count || 1;
  var config = opts.config;
  var marshals = Object.keys(this.marshals);

  if (marshals.length < 1) return callback(new Error('no marshals'));

  var result = {marshals: {}};

  // When spawing one at a time into multiple marshals,
  // this makes it not always spawn into the first marshal
  var lastOffset = this.lastOffset || 0;
  for (var i = lastOffset + 1; i < count + lastOffset + 1; i++) {

    var offset = i % marshals.length;
    this.lastOffset = offset;

    var next = marshals[offset];

    $happn.emit('minion/spawn/at/' + next, {config: config});

    result.marshals[next] = result.marshals[next] || {spawning: 0};
    result.marshals[next].spawning++;
  }
  
  callback(null, result);

}
