#!/usr/bin/env node

var opts = JSON.parse(process.argv[2]);

var name = opts.name;
var marshal = opts.marshal;
var config = opts.config.config || 'default';
var endpoint = opts.config.endpoint;
var user = opts.user || {};

var endpointConfig = 
  endpoint == 'insecure' ? {
    config: {
      host: process.env.INSECURE_ADDRESS,
      port: process.env.INSECURE_PORT,
    }
  } : endpoint == 'secure' ? {
    config: {
      host: process.env.SECURE_ADDRESS,
      port: process.env.SECURE_PORT,
      username: user.name || 'guest',
      password: user.password || ''
    }
  } : { // default
    config: {
      host: process.env.INSECURE_ADDRESS,
      port: process.env.INSECURE_PORT, 
    }
  };

endpointConfig.name = endpoint;

var config = require('../configs/minion_' + config).createConfig(name, endpointConfig);

var Happner = require('happner');

var error = function(e) {
  // TODO: tell marshal...
  console.error(e);
  process.exit(1);
}

var run = function(mesh) {}

Happner.create(config).then(run).catch(error);
